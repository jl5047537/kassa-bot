# Техническое задание: Система Kassa Bot

## 1. Общее описание проекта
Проект представляет собой комплексную систему для управления кассой и реферальной системой через Telegram бота с веб-интерфейсом, использующую блокчейн TON для проведения платежей.

## 2. Функциональные требования

### 2.1. Telegram Бот
#### 2.1.1. Регистрация пользователей
- Команда `/start` для начала работы
- Автоматическое определение реферала при регистрации
- Поддержка предустановленных данных из конфигурационного файла
- Сохранение данных пользователя:
  - Telegram ID
  - Номер телефона
  - TON-адрес
  - Уровень пользователя
  - Реферальная информация
  - Временная метка регистрации

#### 2.1.2. Система уровней
- 5 уровней пользователей (1-5)
- Предустановленные пользователи для каждого уровня
- Автоматическое повышение уровня после выполнения всех платежей
- Хранение информации о платежах для каждого уровня

#### 2.1.3. Платежная система
- Команда `/pay` для просмотра доступных платежей
- Автоматическая проверка транзакций в сети TON
- Поддержка платежей в размере 1 TON
- Нормализация TON-адресов
- Подтверждение платежей через команду `/confirm_payment`

#### 2.1.4. Управление данными пользователя
- Команда `/set_phone` для установки номера телефона
- Команда `/set_address` для установки TON-адреса
- Команда `/status` для просмотра текущего статуса

### 2.2. Веб-приложение

#### 2.2.1. Аутентификация
- Интеграция с Telegram Login Widget
- JWT-токены для авторизации
- Валидация данных от Telegram

#### 2.2.2. Реферальная система
- Создание реферальных кругов
- Отслеживание рефералов
- История реферальных операций
- Статусы реферальных кругов (active/closed)

#### 2.2.3. Управление кошельками
- Подключение TON-кошельков
- Проверка статуса кошелька
- Валидация адресов

## 3. Технические требования

### 3.1. Серверная часть
- Python 3.x
- FastAPI (v0.109.2)
- SQLAlchemy (v2.0.27)
- Alembic для миграций
- python-telegram-bot (v20.8)
- Асинхронная обработка запросов

### 3.2. База данных
#### 3.2.1. Основные таблицы:
- users
- payments
- referral_circles
- referrals
- referral_history

### 3.3. API Интеграции
- Telegram Bot API
- TON API (testnet.toncenter.com)
- Поддержка webhook и long polling

### 3.4. Мониторинг и логирование
- Детальное логирование операций
- Мониторинг транзакций каждую минуту
- Проверка здоровья системы
- Логирование в файл kassa_bot.log

## 4. Конфигурация

### 4.1. Конфигурационные файлы
- `.env` - переменные окружения
- `user_config.json` - предустановленные пользователи
- `levels_config.json` - конфигурация уровней
- `alembic.ini` - настройки миграций

### 4.2. Переменные окружения
- TOKEN - токен Telegram бота
- TON_API_KEY - ключ API TON
- Настройки базы данных
- Параметры безопасности

## 5. Безопасность

### 5.1. Защита данных
- Валидация входных данных
- Защита от SQL-инъекций через ORM
- Безопасное хранение токенов и ключей
- Нормализация адресов и валидация форматов

### 5.2. Авторизация
- Проверка подписи данных Telegram
- Валидация JWT-токенов
- Разграничение доступа по уровням

## 6. Масштабируемость
- Асинхронная обработка запросов
- Поддержка миграций базы данных
- Модульная архитектура
- Возможность горизонтального масштабирования

## 7. Мониторинг и обслуживание
- Автоматический мониторинг транзакций
- Система логирования
- Проверка здоровья системы
- Backup базы данных

## 8. Требования к развертыванию
- Python 3.x
- Виртуальное окружение
- Установка зависимостей из requirements.txt
- Настройка переменных окружения
- Применение миграций базы данных

## 9. Дополнительные требования
- Обработка ошибок и исключений
- Информативные сообщения пользователю
- Документация API
- Тестовое покрытие кода 