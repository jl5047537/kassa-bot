# План реорганизации системы пользователей (21.03.2024)

## Текущее состояние системы

### Типы пользователей
- [x] Администратор (level 0)
- [x] Наставники (levels 1-4)
- [x] Обычные пользователи (level 0)

### Проблемы в текущей логике
- [x] Поиск пользователей происходит по telegram_id, что неверно
- [ ] Нет четкого разделения между типами пользователей
- [ ] Сложная логика проверки и создания пользователей

### Зависимости
- [x] Таблица preset_users содержит предустановленных пользователей
- [x] Таблица users содержит всех пользователей системы
- [x] Логика регистрации находится в нескольких файлах

## Анализ проблем

### Несогласованность в формате номеров телефонов
- [x] В update_preset_users_table.sql номера хранятся с +
- [x] В validators.py номера очищаются от всех нецифровых символов
- [x] В handle_contact используется номер как есть

### Сложная логика проверки пользователей
- [x] Сначала проверяется telegram_id
- [x] Затем проверяется номер телефона
- [x] Много условий и ветвлений

### Проблемы с моделями данных
- [x] В User модель использует id как telegram_id
- [x] В Admin модель имеет отдельное поле telegram_id
- [x] В PresetUser нет четкой связи с другими моделями

## План изменений

### 1. Упрощение логики регистрации
- [x] Проверять только номер телефона
- [ ] Создавать пользователя на основе типа (админ/наставник/обычный)
- [ ] Использовать единый формат номеров (без +)

### 2. Унификация моделей данных
- [ ] Создать базовую модель пользователя
- [ ] Наследовать от нее модели для разных типов
- [ ] Добавить четкие связи между моделями

### 3. Упрощение валидации
- [ ] Создать единую функцию проверки номера
- [ ] Убрать дублирование кода
- [ ] Сделать проверку более понятной

## Текущий прогресс
- [x] Добавлен столбец telegram_id в таблицу users
- [x] Проведен анализ текущей логики
- [x] Выявлены все проблемы
- [x] Подготовлен план реорганизации системы

## Следующие шаги
1. Создание базовой модели пользователя
2. Унификация формата номеров телефонов
3. Переработка логики регистрации
4. Обновление валидации
5. Тестирование изменений

## Статус выполнения
- [x] Анализ текущего состояния
- [x] Выявление проблем
- [x] Составление плана
- [ ] Реализация изменений
- [ ] Тестирование
- [ ] Документирование 